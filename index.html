import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Trophy, Clock, RefreshCw, Play, X } from 'lucide-react';

const ThanksgivingChase = () => {
  const [gameState, setGameState] = useState('menu'); // menu, playing, gameOver
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(30);
  const [turkeys, setTurkeys] = useState([]);
  const [particles, setParticles] = useState([]);
  
  // Game Configuration
  const SPAWN_RATE = 800; // ms between spawns
  const GAME_DURATION = 30;
  
  const requestRef = useRef();
  const lastSpawnTime = useRef(0);
  const playAreaRef = useRef(null);

  // Start Game
  const startGame = () => {
    setGameState('playing');
    setScore(0);
    setTimeLeft(GAME_DURATION);
    setTurkeys([]);
    setParticles([]);
    lastSpawnTime.current = Date.now();
  };

  // Game Loop
  const updateGame = useCallback(() => {
    if (gameState !== 'playing') return;

    const now = Date.now();
    const dt = 16; // Approx 60fps

    // Spawn Turkeys
    if (now - lastSpawnTime.current > SPAWN_RATE) {
      spawnTurkey();
      lastSpawnTime.current = now;
    }

    setTurkeys(prevTurkeys => 
      prevTurkeys
        .map(t => ({
          ...t,
          x: t.x + (t.direction === 'right' ? t.speed : -t.speed),
          // Simple running animation frame toggle
          frame: (Math.floor(now / 100) % 2) 
        }))
        .filter(t => t.x > -10 && t.x < 110) // Remove if off screen (using % for x)
    );

    requestRef.current = requestAnimationFrame(updateGame);
  }, [gameState]);

  useEffect(() => {
    if (gameState === 'playing') {
      requestRef.current = requestAnimationFrame(updateGame);
    }
    return () => cancelAnimationFrame(requestRef.current);
  }, [gameState, updateGame]);

  // Timer
  useEffect(() => {
    let interval;
    if (gameState === 'playing' && timeLeft > 0) {
      interval = setInterval(() => {
        setTimeLeft(prev => {
          if (prev <= 1) {
            setGameState('gameOver');
            return 0;
          }
          return prev - 1;
        });
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [gameState, timeLeft]);

  const spawnTurkey = () => {
    const direction = Math.random() > 0.5 ? 'right' : 'left';
    const startX = direction === 'right' ? -10 : 110;
    // Randomize vertical position (10% to 80% of screen height)
    const startY = 10 + Math.random() * 70; 
    
    setTurkeys(prev => [...prev, {
      id: Date.now() + Math.random(),
      x: startX,
      y: startY,
      direction,
      speed: 0.2 + Math.random() * 0.4, // Random speed
      scale: 0.8 + Math.random() * 0.5, // Random size
      type: Math.random() > 0.8 ? 'gold' : 'standard' // 20% chance of golden turkey
    }]);
  };

  const catchTurkey = (id, x, y, type) => {
    if (gameState !== 'playing') return;

    // Add Score
    const points = type === 'gold' ? 5 : 1;
    setScore(prev => prev + points);

    // Remove Turkey
    setTurkeys(prev => prev.filter(t => t.id !== id));

    // Create Explosion/Feather effect
    const newParticles = Array.from({ length: 8 }).map((_, i) => ({
      id: Date.now() + i,
      x,
      y,
      vx: (Math.random() - 0.5) * 2,
      vy: (Math.random() - 0.5) * 2,
      life: 1.0,
      color: type === 'gold' ? '#fbbf24' : '#ea580c'
    }));
    
    // We update particles in a separate state, but for simplicity in this loop 
    // we'll just set them and let CSS handle fade out or simple cleanup
    setParticles(prev => [...prev, ...newParticles]);

    // Clean up particles after animation
    setTimeout(() => {
      setParticles(prev => prev.filter(p => p.id < Date.now()));
    }, 1000);
  };

  return (
    <div className="fixed inset-0 overflow-hidden font-sans select-none touch-manipulation">
      
      {/* Animated Sky Background */}
      <div className="absolute inset-0 bg-gradient-to-b from-blue-400 via-orange-300 to-yellow-200 animate-sky-shift" />
      
      {/* Rolling Hills (Static Background Elements) */}
      <div className="absolute bottom-0 left-0 right-0 h-1/3 bg-[#4d7c0f] rounded-t-[50%] scale-150 translate-y-10 opacity-80" />
      <div className="absolute bottom-0 left-0 right-0 h-1/4 bg-[#3f6212] rounded-t-[100%] scale-110 translate-y-4" />

      {/* Clouds */}
      <Cloud style={{ top: '10%', left: '10%', animationDuration: '40s' }} />
      <Cloud style={{ top: '20%', left: '60%', animationDuration: '60s' }} />
      <Cloud style={{ top: '15%', left: '80%', animationDuration: '50s' }} />

      {/* Game UI Overlay */}
      <div className="absolute top-0 left-0 right-0 p-4 flex justify-between items-start z-20 pointer-events-none">
        <div className="bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg border-2 border-orange-200 flex flex-col gap-1">
          <div className="flex items-center gap-2 text-orange-800 font-bold text-xl">
            <Trophy size={24} className="text-yellow-500" />
            <span>{score}</span>
          </div>
          <div className="text-xs text-orange-600 font-bold uppercase tracking-wider">Score</div>
        </div>

        <div className={`bg-white/90 backdrop-blur-sm p-3 rounded-2xl shadow-lg border-2 ${timeLeft < 10 ? 'border-red-400 animate-pulse' : 'border-orange-200'} flex flex-col gap-1 items-end`}>
          <div className={`flex items-center gap-2 font-bold text-xl ${timeLeft < 10 ? 'text-red-600' : 'text-orange-800'}`}>
            <span>{timeLeft}s</span>
            <Clock size={24} />
          </div>
          <div className="text-xs text-orange-600 font-bold uppercase tracking-wider">Time Left</div>
        </div>
      </div>

      {/* Main Game Area */}
      <div ref={playAreaRef} className="absolute inset-0 z-10 overflow-hidden">
        {turkeys.map(turkey => (
          <div
            key={turkey.id}
            onClick={(e) => {
              e.stopPropagation();
              catchTurkey(turkey.id, turkey.x, turkey.y, turkey.type);
            }}
            className="absolute cursor-pointer transform transition-transform active:scale-90 hover:scale-110"
            style={{
              left: `${turkey.x}%`,
              top: `${turkey.y}%`,
              width: `${80 * turkey.scale}px`,
              height: `${80 * turkey.scale}px`,
              transform: `scaleX(${turkey.direction === 'left' ? 1 : -1})`, // Flip based on direction
              zIndex: Math.floor(turkey.y) // Simple depth sorting
            }}
          >
             <RunningTurkeySVG frame={turkey.frame} type={turkey.type} />
          </div>
        ))}

        {/* Catch Effects */}
        {particles.map(p => (
          <div
            key={p.id}
            className="absolute w-2 h-2 rounded-full animate-ping"
            style={{
              left: `${p.x}%`,
              top: `${p.y}%`,
              backgroundColor: p.color,
              opacity: 0.8
            }}
          />
        ))}
      </div>

      {/* Menu Screens */}
      {gameState === 'menu' && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4">
          <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl text-center border-4 border-orange-500 transform transition-all animate-in fade-in zoom-in duration-300">
            <h1 className="text-4xl md:text-5xl font-extrabold text-orange-800 mb-2 font-serif">Turkey Chase</h1>
            <h2 className="text-xl text-orange-600 font-bold mb-6">Thanksgiving 2025</h2>
            
            <p className="text-stone-600 mb-8 text-lg">
              The turkeys are escaping! Catch as many as you can before dinner time runs out.
              <br/><br/>
              <span className="text-sm font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded">Gold Turkeys = 5 pts!</span>
            </p>

            <button 
              onClick={startGame}
              className="w-full bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white text-xl font-bold py-4 rounded-xl shadow-lg transform transition active:scale-95 flex items-center justify-center gap-3"
            >
              <Play fill="currentColor" /> Start Chasing
            </button>
          </div>
        </div>
      )}

      {gameState === 'gameOver' && (
        <div className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-md p-4">
          <div className="bg-white rounded-3xl p-8 max-w-md w-full shadow-2xl text-center border-4 border-orange-500 animate-in slide-in-from-bottom-10">
            <div className="absolute -top-12 left-1/2 transform -translate-x-1/2">
              <div className="bg-yellow-400 p-4 rounded-full shadow-xl border-4 border-white">
                <Trophy size={48} className="text-white" />
              </div>
            </div>

            <h2 className="text-3xl font-bold text-stone-800 mt-8 mb-2">Time's Up!</h2>
            <div className="text-6xl font-black text-orange-600 mb-2">{score}</div>
            <p className="text-stone-500 uppercase tracking-widest font-bold text-sm mb-8">Turkeys Caught</p>

            <div className="space-y-3">
              <button 
                onClick={startGame}
                className="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow-md hover:bg-orange-600 transition flex items-center justify-center gap-2"
              >
                <RefreshCw size={20} /> Play Again
              </button>
              <button 
                onClick={() => setGameState('menu')}
                className="w-full bg-stone-100 text-stone-600 font-bold py-3 rounded-xl hover:bg-stone-200 transition"
              >
                Back to Menu
              </button>
            </div>
            
            <p className="mt-6 text-xs text-stone-400">Happy Thanksgiving 2025!</p>
          </div>
        </div>
      )}

      <style>{`
        @keyframes sky-shift {
          0% { background-position: 0% 0%; }
          100% { background-position: 0% 100%; }
        }
        @keyframes float {
          0%, 100% { transform: translateY(0); }
          50% { transform: translateY(-10px); }
        }
      `}</style>
    </div>
  );
};

// --- Components ---

const Cloud = ({ style }) => (
  <div className="absolute opacity-80" style={style}>
    <svg width="100" height="60" viewBox="0 0 100 60" fill="white">
      <path d="M10 40 Q20 20 40 30 Q50 10 70 30 Q90 20 90 40 Q100 60 70 60 L30 60 Q0 60 10 40 Z" />
    </svg>
  </div>
);

const RunningTurkeySVG = ({ frame, type }) => {
  const isGold = type === 'gold';
  const bodyColor = isGold ? '#fbbf24' : '#78350f'; // Gold or Brown
  const tailColor1 = isGold ? '#fcd34d' : '#ea580c';
  const tailColor2 = isGold ? '#f59e0b' : '#c2410c';

  return (
    <svg viewBox="0 0 100 100" className="w-full h-full drop-shadow-lg">
      <g transform="translate(0, 5)">
        {/* Animated Legs */}
        <g transform={`rotate(${frame ? 20 : -20} 45 80)`}>
          <path d="M45 70 L 45 90 L 40 95" stroke="#facc15" strokeWidth="3" fill="none" />
        </g>
        <g transform={`rotate(${frame ? -20 : 20} 55 80)`}>
          <path d="M55 70 L 55 90 L 60 95" stroke="#facc15" strokeWidth="3" fill="none" />
        </g>

        {/* Tail */}
        <path d="M10 50 Q 5 20 30 20 L 30 60 Z" fill={tailColor1} />
        <path d="M20 50 Q 15 10 40 20 L 40 60 Z" fill={tailColor2} />

        {/* Body */}
        <ellipse cx="50" cy="60" rx="25" ry="20" fill={bodyColor} />
        
        {/* Wing */}
        <path d="M40 55 Q 30 70 50 70" stroke={isGold ? '#b45309' : '#451a03'} strokeWidth="2" fill="none" />

        {/* Head/Neck */}
        <g transform="translate(65, 40)">
          <circle cx="0" cy="0" r="12" fill={bodyColor} />
          {/* Beak */}
          <path d="M8 -2 L 18 2 L 8 6 Z" fill="#facc15" />
          {/* Snood */}
          <path d="M6 4 Q 8 12 4 15" stroke="#dc2626" strokeWidth="3" strokeLinecap="round" />
          {/* Eye */}
          <circle cx="2" cy="-2" r="2" fill="white" />
          <circle cx="3" cy="-2" r="1" fill="black" />
        </g>
      </g>
    </svg>
  );
};

export default ThanksgivingChase;
